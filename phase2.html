<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食店 座席マネジメント最適化デモ (Phase 2)</title>
    <!-- Chart.jsの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 24px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .info-box {
            background-color: #e1f5fe;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h2 {
            margin-top: 0;
            font-size: 18px;
            color: #0277bd;
        }
        .info-box p {
            margin-bottom: 5px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (min-width: 1024px) {
            .grid-cols-3 {
                grid-template-columns: 1fr 2fr;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
        }
        .stat-box {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stats-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        @media (min-width: 768px) {
            .stats-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        .kpi-item {
            margin-bottom: 10px;
        }
        .kpi-item h3 {
            margin-top: 0;
            font-size: 14px;
            color: #607d8b;
            margin-bottom: 5px;
        }
        .kpi-item p.value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .text-green {
            color: #4caf50;
        }
        .text-blue {
            color: #2196f3;
        }
        .text-yellow {
            color: #ff9800;
        }
        .text-red {
            color: #f44336;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            width: 100%;
        }
        button {
            background-color: #2196f3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1976d2;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .alert-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .alert-warning {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        .alert-close {
            background: none;
            color: inherit;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
            width: auto;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background-color: #f5f5f5;
            text-align: left;
            padding: 10px;
            font-weight: 600;
        }
        td {
            padding: 10px;
            border-top: 1px solid #eee;
        }
        tr.highlight {
            background-color: #e3f2fd;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .badge-warning {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        .floor-layout {
            position: relative;
            height: 600px;
            background-color: #f8f9fa;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }
        .table-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .footer {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .footer h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .footer ul {
            margin-top: 5px;
            padding-left: 25px;
        }
        .footer p {
            margin-bottom: 5px;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-gray {
            color: #6b7280;
        }
        /* テーブルスタイル */
        .table-item {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 2;
            transition: all 0.3s ease;
        }
        /* 構造物スタイル */
        .structure {
            position: absolute;
            background-color: #9e9e9e;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .cancel-btn {
            color: #f44336;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            width: auto;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>飲食店 座席マネジメント最適化デモ (Phase 2)</h1>
        
        <div class="info-box">
            <h2>座席マネジメント概要</h2>
            <p>過去の来店データと予約情報から、最適な座席配置とリソース配分を行うシステムです。</p>
            <p>※このデモでは単一日のシミュレーションを表示しています</p>
        </div>
        
        <div id="alert-container" style="display: none;" class="alert">
            <span id="alert-message"></span>
            <button class="alert-close" onclick="dismissAlert()">×</button>
        </div>
        
        <div class="grid grid-cols-3">
            <!-- KPIと設定 -->
            <div>
                <div class="stat-box" style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">店舗KPI</h3>
                    
                    <div class="kpi-item">
                        <h3>総座席数</h3>
                        <p class="value" id="total-seats">52席</p>
                    </div>
                    
                    <div class="kpi-item">
                        <h3>座席利用率</h3>
                        <p class="value" id="seating-efficiency">65%</p>
                    </div>
                    
                    <div class="kpi-item">
                        <h3>テーブル効率</h3>
                        <p class="value" id="table-efficiency">78%</p>
                    </div>
                    
                    <div class="kpi-item">
                        <h3>座席回転率</h3>
                        <p class="value" id="turnover-rate">1.5回/時</p>
                    </div>
                    
                    <div class="kpi-item">
                        <h3>運用状態</h3>
                        <p class="value" id="operational-status">最適運用中</p>
                    </div>
                </div>
                
                <div class="stat-box">
                    <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">最適化設定</h3>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">最適化モード</label>
                        <select id="optimization-mode" onchange="changeOptimizationMode()">
                            <option value="efficiency">効率重視（最大回転率）</option>
                            <option value="comfort">快適性重視（顧客体験）</option>
                            <option value="event">イベント対応（宴会席確保）</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">時間帯選択</label>
                        <select id="time-selector" onchange="changeTimeSlot()">
                            <!-- 時間帯はJSで動的に生成 -->
                        </select>
                    </div>
                    
                    <button onclick="optimizeSeating()">座席配置最適化実行</button>
                </div>
            </div>
            
            <!-- 座席レイアウト -->
            <div>
                <div class="stat-box">
                    <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">座席レイアウト (<span id="current-time">12:00</span>)</h3>
                    
                    <div class="floor-layout" id="floor-layout">
                        <!-- レイアウトはJSで動的に生成 -->
                    </div>
                    
                    <div class="table-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF9800;"></div>
                            <span class="text-sm">カウンター席 (1人)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2196F3;"></div>
                            <span class="text-sm">2人テーブル</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4CAF50;"></div>
                            <span class="text-sm">4人テーブル</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9C27B0;"></div>
                            <span class="text-sm">6人テーブル</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #E91E63;"></div>
                            <span class="text-sm">宴会席(10人)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FFC107;"></div>
                            <span class="text-sm">ウォークイン確保</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e0e0e0;"></div>
                            <span class="text-sm">空席</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2">
            <!-- 来店予測グラフ -->
            <div class="stat-box">
                <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">時間帯別来客予測</h3>
                <div class="chart-container">
                    <canvas id="visitors-chart"></canvas>
                </div>
                <p class="text-sm text-gray">※フェーズ1の来店予測AIモデルによる予測値</p>
                <p class="text-sm text-gray">※ピーク時間帯: ランチ(12-13時)、ディナー(19-20時)</p>
            </div>
            
            <!-- 予約リスト -->
            <div class="stat-box">
                <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">予約・席割り当て状況</h3>
                <div class="table-container">
                    <table id="reservations-table">
                        <thead>
                            <tr>
                                <th>予約者</th>
                                <th>時間</th>
                                <th>人数</th>
                                <th>席番号</th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 予約データはJSで動的に生成 -->
                        </tbody>
                    </table>
                </div>
                <p class="text-sm text-gray">※青い行は現在選択中の時間帯の予約です</p>
            </div>
        </div>
        
        <!-- 時間帯別座席利用率 -->
        <div class="stat-box">
            <h3 style="font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">時間帯別座席利用率予測</h3>
            <div class="chart-container">
                <canvas id="utilization-chart"></canvas>
            </div>
            <p class="text-sm text-gray">※オレンジ点線は混雑警告しきい値(85%)です</p>
        </div>
        
        <div class="footer">
            <h2>フェーズ2成果物</h2>
            <ul>
                <li>来店予測と連携した座席最適化アルゴリズム</li>
                <li>予約データと座席在庫の引当管理システム</li>
                <li>時間帯・曜日別の最適化パラメータ設定</li>
                <li>複数の最適化モード（効率/快適性/イベント対応）</li>
                <li>KPIダッシュボードと改善サイクル</li>
            </ul>
            <div style="margin-top: 15px;">
                <p style="font-weight: 600;">次フェーズへの展開</p>
                <p>フェーズ3では、POSシステムとの連携による実店舗でのPilot運用を実施します</p>
            </div>
        </div>
    </div>

    <script>
        // テーブルタイプの定義
        const tableTypes = {
            'counter': { capacity: 1, color: '#FF9800', name: 'カウンター席', width: 40, height: 40 },
            'table_2': { capacity: 2, color: '#2196F3', name: '2人テーブル', width: 60, height: 60 },
            'table_4': { capacity: 4, color: '#4CAF50', name: '4人テーブル', width: 80, height: 80 },
            'table_6': { capacity: 6, color: '#9C27B0', name: '6人テーブル', width: 100, height: 100 },
            'party_10': { capacity: 10, color: '#E91E63', name: '宴会席(10人)', width: 160, height: 100 }
        };
        
        // グローバル変数
        let tables = [];
        let timeSlots = [];
        let selectedTimeIndex = 2; // デフォルトで12:00を選択
        let reservations = [];
        let optimizationMode = 'efficiency';
        let predictedVisits = [];
        let visitorsChart;
        let utilizationChart;
        let kpis = {};
        
        // 初期化
        window.onload = function() {
            initializeData();
            setupTimeSelector();
            renderFloorLayout();
            renderReservationsTable();
            createVisitorsChart();
            createUtilizationChart();
            optimizeSeating(); // 初期状態で最適化実行
        };
        
        // 初期データの設定
        function initializeData() {
            // テーブル配置の初期化
            tables = [
                { id: 1, type: 'counter', x: 50, y: 20, reserved: false, partySize: 0 },
                { id: 2, type: 'counter', x: 100, y: 20, reserved: false, partySize: 0 },
                { id: 3, type: 'counter', x: 150, y: 20, reserved: false, partySize: 0 },
                { id: 4, type: 'counter', x: 200, y: 20, reserved: false, partySize: 0 },
                { id: 5, type: 'counter', x: 250, y: 20, reserved: false, partySize: 0 },
                { id: 6, type: 'counter', x: 300, y: 20, reserved: false, partySize: 0 },
                { id: 7, type: 'table_2', x: 50, y: 100, reserved: false, partySize: 0 },
                { id: 8, type: 'table_2', x: 150, y: 100, reserved: false, partySize: 0 },
                { id: 9, type: 'table_2', x: 250, y: 100, reserved: false, partySize: 0 },
                { id: 10, type: 'table_4', x: 100, y: 200, reserved: false, partySize: 0 },
                { id: 11, type: 'table_4', x: 250, y: 200, reserved: false, partySize: 0 },
                { id: 12, type: 'table_4', x: 100, y: 300, reserved: false, partySize: 0 },
                { id: 13, type: 'table_4', x: 250, y: 300, reserved: false, partySize: 0 },
                { id: 14, type: 'table_6', x: 100, y: 400, reserved: false, partySize: 0 },
                { id: 15, type: 'party_10', x: 250, y: 400, reserved: false, partySize: 0 },
            ];
            
            // 時間帯の生成（11:00〜22:00、30分刻み）
            timeSlots = [];
            for (let hour = 11; hour <= 22; hour++) {
                timeSlots.push({ time: `${hour}:00`, value: hour * 100 });
                if (hour < 22) timeSlots.push({ time: `${hour}:30`, value: hour * 100 + 30 });
            }
            
            // 予測来店数の生成
            predictedVisits = timeSlots.map((slot, index) => {
                // 曜日効果（土日は多い）
                const weekendEffect = 1.2;
                
                // 時間帯効果（ランチピーク: 12-13時、ディナーピーク: 19-20時）
                let timeEffect = 1.0;
                const time = slot.value;
                if (time >= 1200 && time <= 1330) timeEffect = 1.8; // ランチピーク
                else if (time >= 1900 && time <= 2030) timeEffect = 2.0; // ディナーピーク
                else if (time >= 1400 && time <= 1700) timeEffect = 0.6; // 間の時間
                
                // 基本来客数 × 各種効果
                const baseVisitors = 8;
                const predictedVisitors = Math.round(baseVisitors * weekendEffect * timeEffect * (0.9 + Math.random() * 0.2));
                
                return {
                    time: slot.time,
                    predicted: predictedVisitors
                };
            });
            
            // 予約データの生成
            reservations = [
                { id: 1, name: '山田様', time: '12:00', partySize: 4, tableId: null, status: 'confirmed' },
                { id: 2, name: '鈴木様', time: '12:30', partySize: 2, tableId: null, status: 'confirmed' },
                { id: 3, name: '佐藤様', time: '19:00', partySize: 6, tableId: null, status: 'confirmed' },
                { id: 4, name: '田中様', time: '19:30', partySize: 2, tableId: null, status: 'confirmed' },
                { id: 5, name: '伊藤様', time: '20:00', partySize: 10, tableId: null, status: 'confirmed' },
                { id: 6, name: '渡辺様', time: '13:00', partySize: 2, tableId: null, status: 'confirmed' },
                { id: 7, name: '加藤様', time: '18:30', partySize: 4, tableId: null, status: 'confirmed' },
            ];
        }
        
        // 時間選択ドロップダウンの設定
        function setupTimeSelector() {
            const selector = document.getElementById('time-selector');
            selector.innerHTML = '';
            
            timeSlots.forEach((slot, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = slot.time;
                selector.appendChild(option);
            });
            
            // デフォルト値の設定
            selector.value = selectedTimeIndex;
            document.getElementById('current-time').textContent = timeSlots[selectedTimeIndex].time;
        }
        
        // レイアウト描画
        function renderFloorLayout() {
            const layoutContainer = document.getElementById('floor-layout');
            layoutContainer.innerHTML = '';
            
            // 構造物の追加
            // カウンター
            const counter = document.createElement('div');
            counter.className = 'structure';
            counter.style.left = '0px';
            counter.style.top = '0px';
            counter.style.width = '640px';
            counter.style.height = '40px';
            counter.style.backgroundColor = '#795548';
            counter.textContent = 'カウンター';
            layoutContainer.appendChild(counter);
            
            // 壁（右側）
            const rightWall = document.createElement('div');
            rightWall.className = 'structure';
            rightWall.style.right = '0px';
            rightWall.style.top = '40px';
            rightWall.style.width = '80px';
            rightWall.style.height = '560px';
            rightWall.style.backgroundColor = '#9e9e9e';
            rightWall.textContent = '壁';
            layoutContainer.appendChild(rightWall);
            
            // 壁（左側）
            const leftWall = document.createElement('div');
            leftWall.className = 'structure';
            leftWall.style.left = '0px';
            leftWall.style.top = '40px';
            leftWall.style.width = '40px';
            leftWall.style.height = '560px';
            leftWall.style.backgroundColor = '#9e9e9e';
            leftWall.textContent = '入口';
            layoutContainer.appendChild(leftWall);
            
            // キッチン
            const kitchen = document.createElement('div');
            kitchen.className = 'structure';
            kitchen.style.left = '40px';
            kitchen.style.bottom = '0px';
            kitchen.style.width = '520px';
            kitchen.style.height = '80px';
            kitchen.style.backgroundColor = '#9e9e9e';
            kitchen.style.opacity = '0.7';
            kitchen.textContent = 'キッチン';
            layoutContainer.appendChild(kitchen);
            
            // テーブルの描画
            tables.forEach(table => {
                const tableInfo = tableTypes[table.type];
                let bgColor = table.reserved ? tableInfo.color : '#e0e0e0';
                if (table.walkInReserved) bgColor = '#FFC107'; // ウォークイン用
                
                const tableElement = document.createElement('div');
                tableElement.className = 'table-item';
                tableElement.style.left = `${table.x}px`;
                tableElement.style.top = `${table.y}px`;
                tableElement.style.width = `${tableInfo.width}px`;
                tableElement.style.height = `${tableInfo.height}px`;
                tableElement.style.backgroundColor = bgColor;
                tableElement.textContent = table.reserved ? `${table.partySize}人` : tableInfo.capacity;
                tableElement.setAttribute('data-table-id', table.id);
                
                layoutContainer.appendChild(tableElement);
            });
        }
        
        // 予約テーブル描画
        function renderReservationsTable() {
            const tableBody = document.getElementById('reservations-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            reservations.filter(res => res.status !== 'cancelled').forEach(reservation => {
                const row = document.createElement('tr');
                
                // 現在の時間帯と一致する予約は強調表示
                if (timeSlots[selectedTimeIndex].time === reservation.time) {
                    row.className = 'highlight';
                }
                
                // 対応するテーブル情報を取得
                const assignedTable = tables.find(t => t.id === reservation.tableId);
                
                row.innerHTML = `
                    <td>${reservation.name}</td>
                    <td>${reservation.time}</td>
                    <td>${reservation.partySize}人</td>
                    <td>${assignedTable ? 
                          `${assignedTable.id}番 (${tableTypes[assignedTable.type].name})` : 
                          '未割当'}</td>
                    <td>
                        <span class="badge ${reservation.tableId ? 'badge-success' : 'badge-warning'}">
                            ${reservation.tableId ? '割当済' : '未割当'}
                        </span>
                    </td>
                    <td>
                        <button class="cancel-btn" onclick="cancelReservation(${reservation.id})">
                            キャンセル
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 来店予測グラフ作成
        function createVisitorsChart() {
            const ctx = document.getElementById('visitors-chart').getContext('2d');
            
            if (visitorsChart) {
                visitorsChart.destroy();
            }
            
            visitorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: predictedVisits.map(item => item.time),
                    datasets: [{
                        label: '予測来店数',
                        data: predictedVisits.map(item => item.predicted),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '来店人数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        }
                    }
                }
            });
        }
        
        // 座席利用率グラフ作成
        function createUtilizationChart() {
            const ctx = document.getElementById('utilization-chart').getContext('2d');
            
            // 利用率データの作成
            const utilizationData = timeSlots.map((slot, index) => {
                // 時間帯に応じた利用率の計算（シミュレーション）
                let utilizationRate = 0;
                const time = slot.value;
                
                // 時間帯効果
                if (time >= 1200 && time <= 1330) utilizationRate = 85 + Math.floor(Math.random() * 10); // ランチピーク
                else if (time >= 1900 && time <= 2030) utilizationRate = 90 + Math.floor(Math.random() * 10); // ディナーピーク
                else if (time >= 1400 && time <= 1700) utilizationRate = 40 + Math.floor(Math.random() * 20); // 間の時間
                else utilizationRate = 55 + Math.floor(Math.random() * 15); // その他の時間
                
                return {
                    time: slot.time,
                    rate: utilizationRate
                };
            });
            
            if (utilizationChart) {
                utilizationChart.destroy();
            }
            
            utilizationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: utilizationData.map(item => item.time),
                    datasets: [
                        {
                            label: '座席利用率',
                            data: utilizationData.map(item => item.rate),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.2,
                            fill: true
                        },
                        {
                            label: '混雑警告しきい値',
                            data: Array(utilizationData.length).fill(85),
                            borderColor: '#ff9800',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '利用率 (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間帯'
                            }
                        }
                    }
                }
            });
        }
        
        // 時間帯変更処理
        function changeTimeSlot() {
            const selector = document.getElementById('time-selector');
            selectedTimeIndex = parseInt(selector.value);
            document.getElementById('current-time').textContent = timeSlots[selectedTimeIndex].time;
            
            // 選択時間が変わったので最適化を実行
            optimizeSeating();
        }
        
        // 最適化モード変更処理
        function changeOptimizationMode() {
            const selector = document.getElementById('optimization-mode');
            optimizationMode = selector.value;
            
            // 最適化モードが変わったので最適化を実行
            optimizeSeating();
        }
        
        // 座席最適化の実行
        function optimizeSeating() {
            // 現在の時間の予約をフィルタリング
            const currentTimeSlot = timeSlots[selectedTimeIndex].time;
            const currentReservations = reservations.filter(res => 
                res.time === currentTimeSlot && res.status === 'confirmed'
            );
            
            // テーブルの状態をリセット
            tables.forEach(table => {
                table.reserved = false;
                table.partySize = 0;
                table.walkInReserved = false;
            });
            
            // 予約のテーブルIDをリセット
            reservations.forEach(res => {
                if (res.time === currentTimeSlot) {
                    res.tableId = null;
                }
            });
            
            // 最適化モードに応じた処理
            if (optimizationMode === 'efficiency') {
                // 効率性重視: 人数にあった最小サイズのテーブルを割り当て
                assignTablesEfficiency(currentReservations);
                showAlert('success', '最大回転率を重視した座席配置に最適化しました。売上効率が4.3%向上します。');
                
            } else if (optimizationMode === 'comfort') {
                // 快適性重視: 少し大きめのテーブルを割り当て
                assignTablesComfort(currentReservations);
                showAlert('info', '顧客満足度を重視した座席配置に最適化しました。NPS改善が期待できます。');
                
            } else if (optimizationMode === 'event') {
                // イベント対応: 宴会席を優先確保
                assignTablesEvent(currentReservations);
                showAlert('warning', 'イベント対応モードで最適化しました。20:00の宴会予約を確保済みです。');
            }
            
            // ウォークイン用に席を確保（ピーク時間帯）
            reserveForWalkIns();
            
            // レイアウト再描画
            renderFloorLayout();
            renderReservationsTable();
            
            // KPI更新
            updateKPIs();
        }
        
        // 効率重視の席割り当て
        function assignTablesEfficiency(currentReservations) {
            // 人数の多い予約から順に処理
            const sortedReservations = [...currentReservations].sort((a, b) => b.partySize - a.partySize);
            
            sortedReservations.forEach(reservation => {
                // 予約人数以上の座席を持つテーブルを検索（空席のみ）
                const suitableTables = tables.filter(
                    table => tableTypes[table.type].capacity >= reservation.partySize && !table.reserved
                ).sort((a, b) => tableTypes[a.type].capacity - tableTypes[b.type].capacity);
                
                if (suitableTables.length > 0) {
                    // 最小サイズのテーブルを割り当て
                    const tableToReserve = suitableTables[0];
                    tables.find(t => t.id === tableToReserve.id).reserved = true;
                    tables.find(t => t.id === tableToReserve.id).partySize = reservation.partySize;
                    
                    // 予約にテーブルIDを設定
                    const resIndex = reservations.findIndex(r => r.id === reservation.id);
                    reservations[resIndex].tableId = tableToReserve.id;
                }
            });
        }
        
        // 快適性重視の席割り当て
        function assignTablesComfort(currentReservations) {
            // 人数の多い予約から順に処理
            const sortedReservations = [...currentReservations].sort((a, b) => b.partySize - a.partySize);
            
            sortedReservations.forEach(reservation => {
                // 人数より大きめのテーブルを探す
                const preferredCapacity = Math.min(reservation.partySize + 2, 10);
                const suitableTables = tables.filter(
                    table => tableTypes[table.type].capacity >= reservation.partySize && 
                            tableTypes[table.type].capacity <= preferredCapacity && 
                            !table.reserved
                ).sort((a, b) => tableTypes[b.type].capacity - tableTypes[a.type].capacity);
                
                if (suitableTables.length > 0) {
                    // 適切な大きさのテーブルを割り当て
                    const tableToReserve = suitableTables[0];
                    tables.find(t => t.id === tableToReserve.id).reserved = true;
                    tables.find(t => t.id === tableToReserve.id).partySize = reservation.partySize;
                    
                    // 予約にテーブルIDを設定
                    const resIndex = reservations.findIndex(r => r.id === reservation.id);
                    reservations[resIndex].tableId = tableToReserve.id;
                }
            });
        }
        
        // イベント対応モードの席割り当て
        function assignTablesEvent(currentReservations) {
            // 大人数予約（8人以上）を優先的に処理
            const largeParties = currentReservations.filter(res => res.partySize >= 8);
            const normalParties = currentReservations.filter(res => res.partySize < 8);
            
            // 宴会席を大人数予約に割り当て
            largeParties.forEach(reservation => {
                const partyTables = tables.filter(table => table.type === 'party_10' && !table.reserved);
                
                if (partyTables.length > 0) {
                    const tableToReserve = partyTables[0];
                    tables.find(t => t.id === tableToReserve.id).reserved = true;
                    tables.find(t => t.id === tableToReserve.id).partySize = reservation.partySize;
                    
                    // 予約にテーブルIDを設定
                    const resIndex = reservations.findIndex(r => r.id === reservation.id);
                    reservations[resIndex].tableId = tableToReserve.id;
                }
            });
            
            // 残りの予約を通常の優先度で割り当て
            normalParties.forEach(reservation => {
                const suitableTables = tables.filter(
                    table => tableTypes[table.type].capacity >= reservation.partySize && !table.reserved
                ).sort((a, b) => tableTypes[a.type].capacity - tableTypes[b.type].capacity);
                
                if (suitableTables.length > 0) {
                    const tableToReserve = suitableTables[0];
                    tables.find(t => t.id === tableToReserve.id).reserved = true;
                    tables.find(t => t.id === tableToReserve.id).partySize = reservation.partySize;
                    
                    // 予約にテーブルIDを設定
                    const resIndex = reservations.findIndex(r => r.id === reservation.id);
                    reservations[resIndex].tableId = tableToReserve.id;
                }
            });
            
            // 特に20時の宴会予約があれば、他の予約を調整して確保
            const time20Reservation = reservations.find(
                res => res.time === '20:00' && res.partySize >= 8 && res.status === 'confirmed'
            );
            
            if (time20Reservation && currentTimeSlots.time === '20:00') {
                // 20時の宴会予約のための特別処理
                // ここでは簡略化のため省略
            }
        }
        
        // ウォークイン用の席確保
        function reserveForWalkIns() {
            const currentTime = timeSlots[selectedTimeIndex].value;
            
            // ピーク時間帯判定（ランチ: 12-13時、ディナー: 19-20時）
            const isPeakTime = (currentTime >= 1200 && currentTime <= 1330) || 
                              (currentTime >= 1900 && currentTime <= 2030);
            
            if (isPeakTime) {
                // ピーク時は2人席と4人席を少なくとも1つずつウォークイン用に確保
                const emptyTable2 = tables.find(table => table.type === 'table_2' && !table.reserved);
                const emptyTable4 = tables.find(table => table.type === 'table_4' && !table.reserved);
                
                if (emptyTable2) {
                    tables.find(t => t.id === emptyTable2.id).walkInReserved = true;
                }
                
                if (emptyTable4) {
                    tables.find(t => t.id === emptyTable4.id).walkInReserved = true;
                }
            }
        }
        
        // KPI更新
        function updateKPIs() {
            // 総座席数
            const totalSeats = tables.reduce((sum, table) => sum + tableTypes[table.type].capacity, 0);
            
            // 予約済み座席数
            const reservedSeats = tables
                .filter(table => table.reserved)
                .reduce((sum, table) => sum + table.partySize, 0);
            
            // 座席利用効率
            const seatingEfficiency = Math.round((reservedSeats / totalSeats) * 100);
            
            // テーブル利用効率（予約人数/テーブル最大容量の比率）
            const reservedTables = tables.filter(table => table.reserved);
            let tableEfficiency = 0;
            
            if (reservedTables.length > 0) {
                tableEfficiency = Math.round(
                    reservedTables.reduce((sum, table) => 
                        sum + (table.partySize / tableTypes[table.type].capacity), 0) / 
                    reservedTables.length * 100
                );
            }
            
            // 回転率（1時間あたりの入れ替わり回数、シミュレーション）
            const turnoverRate = optimizationMode === 'efficiency' ? 1.7 : 
                               optimizationMode === 'comfort' ? 1.4 : 1.5;
            
            // 運用状態の判定
            let operationalStatus = 'optimal';
            let statusClass = 'text-green';
            
            if (seatingEfficiency > 85) {
                operationalStatus = '混雑注意';
                statusClass = 'text-yellow';
            }
            if (seatingEfficiency > 95) {
                operationalStatus = '満席';
                statusClass = 'text-red';
            }
            
            // KPIの表示更新
            document.getElementById('total-seats').textContent = `${totalSeats}席`;
            document.getElementById('seating-efficiency').textContent = `${seatingEfficiency}%`;
            document.getElementById('table-efficiency').textContent = `${tableEfficiency}%`;
            document.getElementById('turnover-rate').textContent = `${turnoverRate.toFixed(1)}回/時`;
            
            const statusElement = document.getElementById('operational-status');
            statusElement.textContent = operationalStatus;
            statusElement.className = `value ${statusClass}`;
            
            // KPIをグローバル変数に保存
            kpis = {
                totalSeats,
                reservedSeats,
                seatingEfficiency,
                tableEfficiency,
                turnoverRate,
                operationalStatus
            };
            
            // 利用率グラフの更新（選択時間のデータ更新）
            updateUtilizationChart();
        }
        
        // 利用率グラフの更新
        function updateUtilizationChart() {
            if (utilizationChart) {
                // 現在選択中の時間の利用率を実際の値で更新
                const dataIndex = selectedTimeIndex;
                utilizationChart.data.datasets[0].data[dataIndex] = kpis.seatingEfficiency;
                utilizationChart.update();
            }
        }
        
        // 予約キャンセル処理
        function cancelReservation(reservationId) {
            // 該当する予約を探す
            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            // キャンセル状態に更新
            reservation.status = 'cancelled';
            reservation.tableId = null;
            
            // 対応するテーブルの予約状態をリセット
            tables.forEach(table => {
                const reservationForTable = reservations.find(r => 
                    r.tableId === table.id && r.id === reservationId
                );
                if (reservationForTable) {
                    table.reserved = false;
                    table.partySize = 0;
                }
            });
            
            // レイアウト再描画
            renderFloorLayout();
            renderReservationsTable();
            
            // KPI更新
            updateKPIs();
            
            // アラート表示
            showAlert('info', `予約がキャンセルされました。ウォークイン対応に切り替えますか？`);
        }
        
        // アラート表示
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alert-container');
            const alertMessage = document.getElementById('alert-message');
            
            alertContainer.className = `alert alert-${type}`;
            alertMessage.textContent = message;
            alertContainer.style.display = 'flex';
            
            // 5秒後に自動で消える
            setTimeout(dismissAlert, 5000);
        }
        
        // アラート非表示
        function dismissAlert() {
            document.getElementById('alert-container').style.display = 'none';
        }
    </script>
</body>
</html>